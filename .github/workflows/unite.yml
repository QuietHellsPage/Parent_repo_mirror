name: "Sync to child repository"

on:
  push:
    branches: [main]
  issue_comment:
    types: [created]

jobs:
  CreateExternalPR:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && startsWith(github.event.head_commit.message, 'Merge pull request')) ||
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request != null && 
       contains(github.event.comment.body, '[SYNC_TO_CHILD]') && 
       github.event.issue.state == 'open')
    
    steps:
      - name: Extract PR information
        id: extract-info
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            # Для комментария - получаем информацию о ветке PR через GitHub CLI
            echo "Getting PR details for #${{ github.event.issue.number }}"
            
            # Используем GitHub CLI для получения информации о PR
            PR_JSON=$(gh pr view ${{ github.event.issue.number }} --json headRefName,headRefOid,number,author)
            
            HEAD_REF=$(echo "$PR_JSON" | jq -r '.headRefName')
            HEAD_SHA=$(echo "$PR_JSON" | jq -r '.headRefOid')
            PR_AUTHOR=$(echo "$PR_JSON" | jq -r '.author.login')
            
            echo "PR JSON: $PR_JSON"
            echo "Head ref: $HEAD_REF"
            echo "Head SHA: $HEAD_SHA"
            echo "PR author: $PR_AUTHOR"
            
            echo "pr_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "head_ref=$HEAD_REF" >> $GITHUB_OUTPUT
            echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT
            echo "actor=$PR_AUTHOR" >> $GITHUB_OUTPUT
            echo "comment_body=${{ github.event.comment.body }}" >> $GITHUB_OUTPUT
            echo "ref_type=branch" >> $GITHUB_OUTPUT
            
          else
            # Для пуша
            PR_NUMBER=$(echo "${{ github.event.head_commit.message }}" | grep -o 'Merge pull request #' | sed 's/Merge pull request #//' | head -1)
            if [ -z "$PR_NUMBER" ]; then
              PR_NUMBER=$(echo "${{ github.event.head_commit.message }}" | grep -oP 'Merge pull request #\K\d+' | head -1)
            fi
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "head_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "actor=${{ github.event.head_commit.author.name }}" >> $GITHUB_OUTPUT
            echo "comment_body=" >> $GITHUB_OUTPUT
            echo "ref_type=sha" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'issue_comment' && steps.extract-info.outputs.head_ref || steps.extract-info.outputs.head_sha }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup GitHub CLI
        run: |
          bash external_pr_files/setup_cli.sh

      - name: Sync repositories
        run: |
          bash external_pr_files/create_external_pr.sh "${{ github.event.repository.name }}" "${{ steps.extract-info.outputs.pr_number }}"
        env:
          GH_TOKEN: ${{ secrets.TARGET_REPO_PAT }}
          GITHUB_SHA: ${{ steps.extract-info.outputs.head_sha }}
          GITHUB_ACTOR: ${{ steps.extract-info.outputs.actor }}
          COMMENT_BODY: ${{ steps.extract-info.outputs.comment_body }}